<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"
            integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js"></script>

    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="css/style.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />
</head>
<body id="rec">
    <div class="container">
        <div class="row justify-content-center mb-5">
            <div class="inputs" id="inputs">
                <input maxlength="6" id="i1" placeholder="_" value="" />
                <input maxlength="3" id="i2" placeholder="_" value="" />
                <input maxlength="3" id="i3" placeholder="_" value="" />
                <input maxlength="2" id="i4" placeholder="_" value="" />
                <input maxlength="2" id="i5" placeholder="_" value="" />
                <input maxlength="1" id="i6" placeholder="_" value="" />
            </div>
        </div>
    </div>
    <div class="contatiner mt-2">
        <button id="sumbit" type="button" class="btn btn-outline-light btn-lg">Submit</button>

    </div>
    <a class="next-r" href="/send">back</a>
    <footer>
        <iframe id="my_iframe" style="display:none;"></iframe>
    </footer>
</body>
<script>  

    function processInput(holder) {
        var elements = holder.children(), //taking the "kids" of the parent
            str = ""; //unnecesary || added for some future mods

        elements.each(function (e) { //iterates through each element
            var val = $(this).val().replace(/\D/, ""), //taking the value and parsing it. Returns string without changing the value.
                focused = $(this).is(":focus"), //checks if the current element in the iteration is focused
                parseGate = false;

            val.length == 1 ? parseGate = false : parseGate = true;
			/*a fix that doesn't allow the cursor to jump 
			to another field even if input was parsed 
			and nothing was added to the input*/

            $(this).val(val); //applying parsed value.

            if (parseGate && val.length > 1) { //Takes you to another input
                var exist = elements[e + 1] ? true : false; //checks if there is input ahead
                exist && val[1] ? ( //if so then
                    elements[e + 1].disabled = false,
                    elements[e + 1].value = val[1], //sends the last character to the next input
                    elements[e].value = val[0], //clears the last character of this input
                    elements[e + 1].focus() //sends the focus to the next input
                ) : void 0;
            } else if (parseGate && focused && val.length == 0) { //if the input was REMOVING the character, then
                var exist = elements[e - 1] ? true : false; //checks if there is an input before
                if (exist) elements[e - 1].focus(); //sends the focus back to the previous input
            }

            val == "" ? str += " " : str += val;
        });
    }

    $("#inputs").on('input', function () { processInput($(this)) }); //still wonder how it worked out. But we are adding input listener to the parent... (omg, jquery is so smart...);

    $("#inputs").on('click', function (e) { //making so that if human focuses on the wrong input (not first) it will move the focus to a first empty one.
        var els = $(this).children(),
            str = "";
        els.each(function (e) {
            var focus = $(this).is(":focus");
            $this = $(this);
            while ($this.prev().val() == "") {
                $this.prev().focus();
                $this = $this.prev();
            }
        })
    });
    // Function fetching digits from inputs and returning it as a 6 digits number
    function fetchNumberfromInput() {
        var i1 = $("#i1").val();
        var i2 = $("#i2").val();
        var i3 = $("#i3").val();
        var i4 = $("#i4").val();
        var i5 = $("#i5").val();
        var i6 = $("#i6").val();
        return i1 + i2 + i3 + i4 + i5 + i6;
    }
    // Removing values from all inputs
    function clearInputs() {
        $("#i1").val("");
        $("#i2").val("");
        $("#i3").val("");
        $("#i4").val("");
        $("#i5").val("");
        $("#i6").val("");
    }
    // On submit 
    $("#sumbit").on('click', function () {
        // Initialize request
        var request;
        // Siging number to a variable
        var code = fetchNumberfromInput();
        // Checking if enetered code is not empty and have 6 digits
        if (code == "" && code.length != 6 ) {
            toastr.error("Please enter code !");
        }
        else {
            event.preventDefault();
            if (request) {
                request.abort();
            }
            request = $.ajax({
                url: "/getdata",
                type: "get",
                data: {code: code}
            });
            request.done(function (data) {
                // On Success inform user that 
                var reslink = data.link;
                if (reslink == null) {
                    toastr.error("Wrong code entered !")
                }
                else {
                    $("#download_link").attr("href", reslink);
                    $("#download_link").show();
                   /////
                    var image = new Image();
                    image.crossOrigin = "anonymous";
                    image.src = reslink;
                    // get file name - you might need to modify this if your image url doesn't contain a file extension otherwise you can set the file name manually
                    var fileName = image.src.split(/(\\|\/)/g).pop();
                    image.onload = function () {
                        var canvas = document.createElement('canvas');
                        canvas.width = this.naturalWidth; // or 'width' if you want a special/scaled size
                        canvas.height = this.naturalHeight; // or 'height' if you want a special/scaled size
                        canvas.getContext('2d').drawImage(this, 0, 0);
                        var blob;
                        // ... get as Data URI
                        if (image.src.indexOf(".jpg") > -1) {
                            blob = canvas.toDataURL("image/jpeg");
                        } else if (image.src.indexOf(".png") > -1) {
                            blob = canvas.toDataURL("image/png");
                        } else if (image.src.indexOf(".gif") > -1) {
                            blob = canvas.toDataURL("image/gif");
                        } else {
                            blob = canvas.toDataURL("image/png");
                        }
                       //  var element = "'<a id="download_link" download='" + fileName + "' href='" + blob + " type = "button"  class="btn btn-outline-info btn-lg" > Download</a >

                        $("body").html("<b>Click image to download.</b><br><a download='" + fileName + "' href='" + blob + "'><img src='" + blob + "'/></a>");
                    };
                }               
            })
            request.fail(function (jqXHR, textStatus, errorThrown) {                
                // Log the error to the console
                console.error(
                    "The following error occurred: " +
                    textStatus, errorThrown
                );
            }); 
        }
        // clearing inputs after submitting form
        clearInputs();
    });

</script>

</html>

